{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Admin Configuration</h2>

    <div class="config-section">
        <h3>LLM Configuration</h3>
        <div class="form-group">
            <label>Provider</label>
            <select id="llm-provider">
                <option value="openai">OpenAI</option>
                <option value="ollama">Ollama</option>
            </select>
        </div>

        <div id="openai-config">
            <div class="form-group">
                <label>Model Name</label>
                <input type="text" id="openai-model" value="gpt-3.5-turbo">
            </div>
        </div>

        <div id="ollama-config" style="display:none;">
            <div class="form-group">
                <label>Base URL</label>
                <input type="text" id="ollama-url" value="http://localhost:11434">
            </div>
            <div class="form-group">
                <label>Model Name</label>
                <input type="text" id="ollama-model" value="llama2">
            </div>
        </div>
    </div>

    <div class="config-section">
        <h3>1. Google Drive API Credentials</h3>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">
            Obtain these from the <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a>.
        </p>
        <div style="background: #fff9db; border: 1px solid #fab005; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.85rem;">
            <strong style="color: #f08c00;">‚ö†Ô∏è Important:</strong> To avoid "Error 400: redirect_uri_mismatch", you MUST add the following URL to the <strong>Authorized redirect URIs</strong> in your Google Console:
            <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                <code id="redirect-uri-display" style="background: #fff; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0; flex: 1;"></code>
                <button onclick="copyRedirectUri()" style="padding: 4px 8px; font-size: 0.75rem; width: auto; margin: 0; background: #e2e8f0; color: #000; box-shadow: none;">Copy</button>
            </div>
            <hr style="margin: 10px 0; border: 0; border-top: 1px solid #e9ecef;">
            <strong style="color: #f08c00;">üîê Error 403 (access_denied)?</strong> Since the app is in "Testing" mode, you MUST add your email (<code>arjuntheprogrammer@gmail.com</code>) to the <strong>"Test users"</strong> list under the <strong>OAuth Consent Screen</strong> tab in your Google Cloud Console.
        </div>
        <div class="form-group">
            <label>Client ID</label>
            <input type="text" id="google-client-id" placeholder="your-client-id.apps.googleusercontent.com">
        </div>
        <div class="form-group">
            <label>Client Secret</label>
            <input type="password" id="google-client-secret" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button onclick="saveConfig()" class="btn-secondary" style="margin-top: 10px;">Save API Credentials</button>
    </div>

    <div class="config-section">
        <h3>2. Authentication</h3>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">
            Once API credentials are saved, connect your Google Account to authorize file access.
        </p>
        <div id="google-auth-section" style="padding: 15px; background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <div id="drive-auth-status" style="font-weight: 600; margin-bottom: 5px;">Status: Checking...</div>
                <p id="auth-hint" style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">Login required</p>
            </div>
            <button id="auth-btn" class="btn-secondary" onclick="handleGoogleAuth()">Connect Google Account</button>
        </div>
    </div>

    <div id="drive-folders-container" class="config-section" style="display:none;">
        <h3>3. Managed Folders</h3>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">
            Add the folder IDs (or full Google Drive folder URLs) you want the assistant to index.
        </p>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <button onclick="verifyDriveConnection()" style="padding: 0.5rem 1rem; font-size: 0.8rem; background: #e2e8f0; color: #0f172a; box-shadow: none;">Verify Folder Access</button>
            <span style="font-size: 0.8rem; color: var(--text-muted);">Checks the first few folders and reports access.</span>
        </div>
        <div id="drive-folders-list"></div>
        <button onclick="addDriveFolder()" style="background: var(--background-bg); color: var(--text-main); border: 1px dashed #cbd5e1; box-shadow: none; width: 100%; margin-top: 10px; border-radius: 12px; padding: 12px;">+ Add New Folder</button>
    </div>

    <div id="verification-results" style="margin-top: 20px; padding: 15px; border: 1px solid #e2e8f0; background: #fff; border-radius: 12px; display: none;">
        <div style="font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <span style="color: var(--primary-color)">‚ÑπÔ∏è</span> Verification Results
        </div>
        <ul id="files-list" style="margin: 0; padding-left: 20px; font-size: 0.9rem; line-height: 1.6;"></ul>
    </div>

    <button onclick="saveConfig()">Save Configuration</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadConfig();

        const providerSelect = document.getElementById('llm-provider');
        providerSelect.addEventListener('change', (e) => {
            toggleLLMConfig(e.target.value);
        });
    });

    function toggleLLMConfig(provider) {
        document.getElementById('openai-config').style.display = provider === 'openai' ? 'block' : 'none';
        document.getElementById('ollama-config').style.display = provider === 'ollama' ? 'block' : 'none';
    }
</script>
{% endblock %}
